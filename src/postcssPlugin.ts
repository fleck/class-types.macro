import * as appRoot from "app-root-path";
import createSelectorParser from "postcss-selector-parser";
import nodePath from "path";
import fs from "fs-extra";
import postcssLib, { plugin } from "postcss";

const parser = createSelectorParser(selectors => {
  return selectors.nodes
    .map(selector => {
      if (selector.type !== "selector") {
        return "";
      }

      return selector.nodes.map(classNode => {
        if (classNode.type === "class") {
          return classNode.toString().slice(1);
        }
        return "";
      });
    })
    .filter(sel => sel)
    .join(" ");
});

export const defaultDirectory = nodePath.join(
  appRoot.toString(),
  "@types",
  "ct.macro"
);

export const classnamesFilename = "classnames.d.ts";

const initializer = ({ directory = "" } = {}) => {
  const dest = directory || defaultDirectory;

  const indexFileOutput = fs.outputFile(
    nodePath.join(dest, "index.d.ts"),
    `\
// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
declare module "ct.macro" {
const _default: (...args: ClassNames[]) => string;

export default _default;
}`
  );

  return async (root: postcssLib.Root) => {
    const classes: string[] = [];

    root.walkRules(rule => {
      classes.push(
        ...parser.processSync(rule.selector, { lossless: false }).split(" ")
      );
    });

    return Promise.all([
      indexFileOutput,
      fs.outputFile(
        nodePath.join(dest, "classnames.d.ts"),
        `type ClassNames = "${classes.join('" | "')}"`
      ),
      fs.outputJSON(nodePath.join(dest, "classnames.json"), classes),
    ]);
  };
};

type options = Parameters<typeof initializer>[0];

export const postcss = plugin<options>("postcss-ct.macro", initializer);
